#!/bin/bash
set -e

dir=$(cd -P -- "$(dirname -- "$0")" && pwd -P)
MSBUILDEXE="/mnt/c/Program\ Files\ \(x86\)/MSBuild/14.0/Bin/MSBuild.exe"
BUILDCMD="$MSBUILDEXE"

if [[ $1 == "-h" ]]; then
  echo "usage: msbuild <directory/solution/project> <options>"
  echo "msbuid /path/to/project/dir       |  find a solution/project in the dir and build it"
  echo "msbuild       			  |  find a solution/project in the current dir and build it"
  echo "msbuild -r  			  |  rebuild solution/project in the current dir"
  echo "msbuild -c			  |  clean solution/project in the current dir"
  echo "msbuild --target=<TARGET>	  |  set the build target (Debug/Release/etc)"
  echo ""
  echo "Can also pass regular MSBuild arguments: "
  echo ""
  echo "msbuild /t:Rebuild		  |  rebuild solution/project in the current dir"
  echo "msbuild /t:Clean                  |  clean solution/project in the current dir"
  echo "msbuild /p:Configuration=Release  |  set the build target (Debug/Release/etc)"
  exit 1
fi

if [[ -f "$1" || -d "$1" ]]; then
  if [[ $1 == '/mnt/c'* ]]; then
    OLDPATH=$1
    PRJPATH=$(echo $1 | sed 's#/mnt/c#C:#g')
    shift
  else
    echo "Please pass a windows-findable project directory"
    exit 1
  fi
else
  if [[ $PWD == '/mnt/c'* ]]; then
    OLDPATH=$PWD
    PRJPATH=$(echo $PWD | sed 's#/mnt/c#C:#g')
  else
    echo "Please run this command from a windows-findable project directory"
    exit 1
  fi
fi

if [[ -d "$OLDPATH" ]]; then
  SLNFILE=$(find -maxdepth 1 -name "*.sln" | sed "s|^\./||")
  SLNCOUNT=$(echo "$SLNFILE" | wc -l)

  if [[ $SLNCOUNT -eq 1 ]]; then
    PRJPATH="${PRJPATH}/${SLNFILE}"
  elif [[ $SLNCOUNT -gt 1 ]]; then
    echo "Multiple solution files found in directory, please specify manually"
  fi
fi

BUILDCMD="$BUILDCMD \"${PRJPATH}\" /nologo /v:q"

for var in "$@"
do
  if [[ $var == "-r" ]]; then
    BUILDCMD="$BUILDCMD /t:Rebuild"
  elif [[ $var == "-c" ]]; then
    BUILDCMD="$BUILDCMD /t:Clean"
  elif [[ $var == "--target="* ]]; then
    TAR=${var:9}
    if [[ -z "${param// }" ]]; then
      echo "Please specify a target"
      exit 1
    fi

    BUILDCMD="$BUILDMCD /p:Configuration=$TAR"
  else
    BUILDCMD="$BUILDCMD $var"
  fi
done

eval $BUILDCMD
